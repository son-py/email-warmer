<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Email Warmer</title>

<!-- ====== DARK THEME ====== -->
<style>
:root{
  --bg:#0b1220;
  --panel:#0f172a;
  --panel-2:#0e1422;
  --muted:#98a2c3;
  --muted-2:#7e8bb0;
  --text:#e7edff;
  --accent:#6b5cff;
  --accent-2:#4bb3ff;
  --ok:#22c55e;
  --warn:#f59e0b;
  --err:#ef4444;
  --line:#203054;
  --pill:#141c2e;
  --input:#0f1627;
  --input-br:#233052;
}
*{ box-sizing:border-box }
html,body{ height:100% }
body{
  margin:0; background: radial-gradient(1200px 700px at -10% -20%, #13203c 0%, transparent 55%) no-repeat,
              linear-gradient(#0a1120,#080e1a);
  color:var(--text); font: 15px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Inter, sans-serif;
}

/* ====== LAYOUT ====== */
.header{
  padding:28px 18px 16px; position:sticky; top:0; z-index:10;
  background: linear-gradient(180deg, rgba(10,16,28,.95), rgba(10,16,28,.75), transparent);
  backdrop-filter: blur(6px);
  border-bottom: 1px solid rgba(40,58,95,.35);
}
.container{ max-width:1100px; margin:0 auto; padding:0 14px 40px }
.brand{
  display:flex; align-items:center; gap:14px;
}
.brand .logo{
  width:42px; height:42px; border-radius:12px;
  background: linear-gradient(135deg,var(--accent),var(--accent-2));
  display:grid; place-items:center; font-weight:900; color:white; letter-spacing:.5px;
  box-shadow: 0 10px 24px rgba(75,100,255,.25);
}
.brand h1{
  font-size: clamp(22px, 3.2vw, 30px);
  margin:0; letter-spacing:.3px;
}
.brand small{ color:var(--muted); display:block; margin-top:2px }

/* NAV */
.nav{
  margin-top:14px; display:flex; gap:10px; flex-wrap:wrap;
}
.tab{
  cursor:pointer; user-select:none;
  padding:10px 14px; border-radius:12px;
  border: 1px solid var(--line);
  background: linear-gradient(180deg,var(--panel),#0c1426);
  color: var(--text); letter-spacing:.2px;
  transition: .16s ease;
}
.tab:hover{ transform:translateY(-1px); filter:brightness(1.06); border-color:#2a3a61; }
.tab.active{
  background: linear-gradient(90deg,var(--accent),var(--accent-2));
  border-color:transparent; color:#fff; font-weight:600;
}

/* PANELS */
.section{ display:none; margin-top:18px; }
.section.show{ display:block; }
.card{
  background: linear-gradient(180deg,var(--panel-2),var(--panel));
  border: 1px solid var(--line); border-radius:18px; padding:16px;
  box-shadow: 0 8px 28px rgba(0,0,0,.25);
}

/* GRID */
.grid{ display:grid; gap:14px }
@media (min-width: 900px){ .grid-2{ grid-template-columns: 1.2fr .9fr } }

/* TABLE */
.table{ width:100%; border-collapse:separate; border-spacing:0; }
.table th, .table td{ padding:10px 12px; border-bottom:1px solid #1e2a49; text-align:left; }
.table th{ color:var(--muted); font-weight:600; font-size:13px; text-transform:uppercase; letter-spacing:.4px }
.badge{ color:#bcd3ff; font-size:12px }

/* INPUTS + BUTTONS */
.input{
  width:100%; background:var(--input); color:var(--text);
  border:1px solid var(--input-br); border-radius:12px; padding:10px 12px; outline:none;
}
.input::placeholder{ color:var(--muted-2) }
.input:focus{ border-color:#4b64ff; box-shadow: 0 0 0 3px rgba(75,100,255,.18); }

.row{ display:flex; gap:12px }
.row > *{ flex:1 }

.checkbox{ display:flex; align-items:center; gap:10px; color:var(--muted) }

.btn{
  background:#111a2b; border:1px solid #2a3454; color:#dbe6ff;
  padding:10px 14px; border-radius:12px; cursor:pointer; transition:.15s;
}
.btn:hover{ background:#151f33 }
.btn-primary{
  background: linear-gradient(90deg,var(--accent),var(--accent-2));
  border-color: transparent; color:white; font-weight:600;
}
.btn-primary:hover{ filter:brightness(1.05) }
.btn-ghost{
  background: transparent; border:1px solid #27324c; color:#c7d2ff;
  padding:8px 12px; border-radius:10px; line-height:1; cursor:pointer;
}
.btn-ghost:hover{ background:#131b2b; }

/* STATUS DOTS */
.dot{ width:8px; height:8px; border-radius:50%; display:inline-block; margin-right:6px }
.ok{ background:var(--ok) } .warn{ background:var(--warn) } .err{ background:var(--err) }

/* TOASTS */
.toast-wrap{ position: fixed; right:14px; bottom:14px; display:grid; gap:10px; z-index:80 }
.toast{
  padding:12px 14px; border-radius:12px; color:#fff; font-weight:600;
  border:1px solid rgba(255,255,255,.12); backdrop-filter: blur(4px);
  animation: raise .2s ease-out;
}
.toast.ok{ background: linear-gradient(180deg,#22c55e,#168a3e) }
.toast.err{ background: linear-gradient(180deg,#ef4444,#b91c1c) }
.toast.info{ background: linear-gradient(180deg,#475569,#1f2937) }
@keyframes raise{ from{ transform:translateY(6px); opacity: .5 } to{ transform:none; opacity:1 } }

/* TOKEN OVERLAY */
.gate{
  position:fixed; inset:0; background: radial-gradient(800px 500px at 70% -10%, rgba(107,92,255,.16), transparent) no-repeat,
                                rgba(9,14,26,.85);
  display:grid; place-items:center; z-index:100;
}
.gate .panel{
  width:min(520px, 92vw); padding:18px; border-radius:18px;
  background: linear-gradient(180deg,var(--panel-2),var(--panel));
  border:1px solid var(--line); box-shadow: 0 20px 50px rgba(0,0,0,.45);
}
.gate h2{ margin:0 0 6px; font-size:22px }
.gate p{ margin:0 0 12px; color:var(--muted) }
.gate .row{ margin-top:10px }
.err-text{ color:#ffb4b4; font-size:13px; min-height:18px }

/* DASH CARDS */
.kpis{ display:grid; grid-template-columns: repeat(3,1fr); gap:12px }
.kpi{ padding:14px; border:1px solid var(--line); border-radius:16px; background: linear-gradient(180deg,#0f162a,#0e1424) }
.kpi .n{ font-size:26px; font-weight:800 }
.kpi .t{ color:var(--muted); text-transform:uppercase; font-size:12px; letter-spacing:.4px }

/* PEERS MODAL */
.modal { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; z-index: 90; }
.modal.show { display: flex; }
.modal::before { content:""; position:absolute; inset:0; background:rgba(8,12,20,.72); backdrop-filter: blur(6px); }
.modal-card {
  position: relative; width: min(680px, 92vw);
  background: linear-gradient(180deg,#0e1422,#0c1220);
  border: 1px solid #1f2a44; border-radius: 18px;
  box-shadow: 0 10px 32px rgba(0,0,0,.45);
  color: #e6ecff;
  padding: 18px 18px 14px;
  animation: pop .16s ease-out;
}
@keyframes pop { from { transform: translateY(8px) scale(.98); opacity: .6 } to { transform: none; opacity: 1 } }
.modal-head { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px; }
.modal-head h3 { font-size: 20px; font-weight: 700; letter-spacing:.2px; }
.peer-list { display:flex; flex-wrap:wrap; gap:8px; padding:6px 2px 2px; min-height:38px; }
.pill { padding:6px 10px; border-radius:999px; font-size:13px; background: var(--pill); border:1px solid #243252; color:#cfe1ff; }
.peer-add { display:flex; gap:10px; margin-top:14px; }
.modal-foot { display:flex; justify-content:flex-end; margin-top:14px; }

/* UTIL */
.muted{ color:var(--muted) }
.space{ height:4px }
.center{ display:flex; align-items:center; justify-content:center }
.right{ text-align:right }
</style>
</head>

<body>
  <header class="header">
    <div class="container">
      <div class="brand">
        <div class="logo">EW</div>
        <div>
          <h1>Email Warmer</h1>
          <small>Warm up and monitor your sender reputation.</small>
        </div>
      </div>
      <nav class="nav" id="tabs">
        <div class="tab active" data-tab="dash">Dashboard</div>
        <div class="tab" data-tab="inboxes">Inboxes</div>
        <div class="tab" data-tab="logs">Logs</div>
        <div class="tab" data-tab="settings">Settings</div>
      </nav>
    </div>
  </header>

  <main class="container">
    <!-- DASHBOARD -->
    <section id="sec-dash" class="section show">
      <div class="kpis">
        <div class="kpi"><div class="n" id="kpi-inboxes">0</div><div class="t">Connected</div></div>
        <div class="kpi"><div class="n" id="kpi-active">0</div><div class="t">Active</div></div>
        <div class="kpi"><div class="n" id="kpi-target">0</div><div class="t">Daily Target</div></div>
      </div>
      <div class="space"></div>
      <div class="card">
        <div class="row" style="align-items:center">
          <div class="muted">Quick actions</div>
          <div class="right" style="flex:1"></div>
          <button class="btn" id="btn-refresh-all">Refresh</button>
          <button class="btn-primary" id="btn-run-now">Run Now</button>
        </div>
      </div>
    </section>

    <!-- INBOXES -->
    <section id="sec-inboxes" class="section">
      <div class="grid grid-2">
        <div class="card">
          <div class="row" style="align-items:center; margin-bottom:8px">
            <h3 style="margin:0">Connected Inboxes</h3>
            <div style="flex:1"></div>
            <button class="btn" id="btn-reload">Reload</button>
          </div>

          <table class="table" id="ibox-table">
            <thead>
              <tr>
                <th>Label</th><th>Daily target</th><th>Active</th><th>Created</th><th class="right">Actions</th>
              </tr>
            </thead>
            <tbody id="ibox-body"></tbody>
          </table>
        </div>

        <div class="card">
          <h3 style="margin-top:0">Add Inbox</h3>

          <div class="row">
            <div>
              <label class="muted">Label (email address)</label>
              <input id="f-label" class="input" placeholder="inbox@example.com">
            </div>
            <div>
              <label class="muted">Daily target</label>
              <input id="f-target" class="input" type="number" min="1" value="10">
            </div>
          </div>

          <div style="margin-top:10px">
            <label class="muted">Provider</label>
            <select id="f-provider" class="input">
              <option value="smtp" selected>SMTP</option>
              <option value="outlook">Outlook (manual SMTP/IMAP)</option>
              <option value="gmail" disabled>Gmail (use App Password)</option>
            </select>
          </div>

          <h4 class="muted" style="margin:14px 0 6px">SMTP</h4>
          <div class="row">
            <input id="f-smtp-host" class="input" placeholder="smtp.office365.com">
            <input id="f-smtp-port" class="input" placeholder="587" value="587">
          </div>
          <div class="row" style="margin-top:10px">
            <input id="f-smtp-user" class="input" placeholder="SMTP user (full email)">
            <input id="f-smtp-pass" class="input" placeholder="SMTP pass / app password" type="password">
          </div>
          <label class="checkbox" style="margin-top:8px">
            <input id="f-smtp-tls" type="checkbox" checked>
            <span>Use TLS (STARTTLS)</span>
          </label>

          <h4 class="muted" style="margin:14px 0 6px">IMAP</h4>
          <div class="row">
            <input id="f-imap-host" class="input" placeholder="outlook.office365.com">
            <input id="f-imap-port" class="input" placeholder="993" value="993">
          </div>
          <div class="row" style="margin-top:10px">
            <input id="f-imap-user" class="input" placeholder="IMAP user (full email)">
            <input id="f-imap-pass" class="input" placeholder="IMAP pass / app password" type="password">
          </div>
          <label class="checkbox" style="margin-top:8px">
            <input id="f-imap-ssl" type="checkbox" checked>
            <span>Use SSL</span>
          </label>

          <div class="center" style="margin-top:16px">
            <button class="btn-primary" id="btn-create">Create</button>
          </div>
          <div id="create-err" class="err-text"></div>
        </div>
      </div>
    </section>

    <!-- LOGS -->
    <section id="sec-logs" class="section">
      <div class="card">
        <div class="row" style="align-items:center; margin-bottom:8px">
          <h3 style="margin:0">Recent send logs</h3>
          <div style="flex:1"></div>
          <button class="btn" id="btn-logs-reload">Reload</button>
        </div>
        <div id="logs-area" style="white-space:pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; background:#0a1020; border:1px solid #1c2847; border-radius:12px; padding:12px; min-height:180px; color:#d7e2ff"></div>
      </div>
    </section>

    <!-- SETTINGS -->
    <section id="sec-settings" class="section">
      <div class="grid">
        <div class="card">
          <h3 style="margin-top:0">Admin</h3>
          <div class="row">
            <button class="btn-primary" id="btn-run-now-2">Run Now</button>
            <button class="btn" id="btn-change-token">Change Admin Token</button>
          </div>
          <p class="muted" style="margin-top:8px">
            “Run Now” executes one warm-up pass immediately. Token is sent as <code>X-Admin-Token</code>.
          </p>
        </div>
      </div>
    </section>
  </main>

  <!-- Toasts -->
  <div class="toast-wrap" id="toasts"></div>

  <!-- Token Gate -->
  <div class="gate" id="gate" style="display:none">
    <div class="panel">
      <h2>Enter admin access token</h2>
      <p>This site is protected. Provide the server’s <code>X-Admin-Token</code> to continue.</p>
      <div class="row">
        <input id="gate-token" class="input" placeholder="Enter token…">
        <button id="gate-continue" class="btn-primary">Continue</button>
      </div>
      <div id="gate-err" class="err-text"></div>
      <p class="muted" style="margin-top:8px">Tip: you can change this later in <b>Settings → Change Admin Token</b>.</p>
    </div>
  </div>

  <!-- Peers Modal -->
  <div id="peerModal" class="modal" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="peerTitle">
      <div class="modal-head">
        <h3 id="peerTitle">Peers</h3>
        <button class="btn-ghost" id="peerClose">&times;</button>
      </div>

      <div class="peer-list" id="peerList">
        <div class="muted">Loading peers…</div>
      </div>

      <div class="peer-add">
        <input id="peerInput" class="input" placeholder="peer@example.com" autocomplete="off">
        <button id="peerAddBtn" class="btn-primary">Add</button>
      </div>

      <div class="modal-foot">
        <button class="btn" id="peerCloseBottom">Close</button>
      </div>
    </div>
  </div>

<script>
/* ======================= UTILITIES ======================= */
const $ = sel => document.querySelector(sel);
const $$ = sel => document.querySelectorAll(sel);

let ADMIN_TOKEN = localStorage.getItem('X_ADMIN_TOKEN') || '';

function api(path, opts = {}) {
  const headers = {'Content-Type': 'application/json', ...(opts.headers||{})};
  if (ADMIN_TOKEN) headers['X-Admin-Token'] = ADMIN_TOKEN;
  return fetch(path, {...opts, headers});
}
function toast(msg, type='info', ms=3000){
  const wrap = $('#toasts');
  const d = document.createElement('div');
  d.className = `toast ${type}`;
  d.textContent = msg;
  wrap.appendChild(d);
  setTimeout(()=>{ d.style.opacity='0'; d.style.transform='translateY(4px)'; }, ms-200);
  setTimeout(()=>wrap.removeChild(d), ms);
}

/* ======================= NAV TABS ======================= */
const tabEls = $$('#tabs .tab');
tabEls.forEach(t => t.addEventListener('click', () => {
  tabEls.forEach(x => x.classList.remove('active'));
  t.classList.add('active');
  const name = t.dataset.tab;
  $$('.section').forEach(s => s.classList.remove('show'));
  $('#sec-'+name).classList.add('show');
  if (name==='inboxes') loadInboxes();
  if (name==='logs') loadLogs();
  if (name==='dash') refreshKPIs();
}));

/* ======================= TOKEN GATE ======================= */
async function ensureToken(){
  if(!ADMIN_TOKEN){ showGate(); return; }
  // verify by hitting a protected endpoint
  try{
    const r = await api('/inboxes');
    if (r.ok) { $('#gate').style.display='none'; return; }
    showGate('Invalid token (HTTP '+r.status+')');
  }catch(e){
    showGate('Could not reach server');
  }
}
function showGate(err){
  $('#gate').style.display='grid';
  $('#gate-err').textContent = err || '';
}
$('#gate-continue').onclick = async ()=>{
  const token = $('#gate-token').value.trim();
  if(!token){ $('#gate-err').textContent='Please enter a token'; return; }
  ADMIN_TOKEN = token;
  localStorage.setItem('X_ADMIN_TOKEN', ADMIN_TOKEN);
  const r = await api('/inboxes');
  if(r.ok){
    $('#gate').style.display='none';
    toast('Token accepted','ok');
    await refreshAll();
  }else{
    $('#gate-err').textContent='Invalid token (HTTP '+r.status+')';
  }
};
$('#btn-change-token').onclick = ()=>{
  $('#gate-token').value='';
  showGate();
};

/* ======================= DASH KPIs ======================= */
async function refreshKPIs(){
  try{
    const [r1, r2] = await Promise.all([api('/inboxes'), api('/stats')]);
    let ib = [], stats = {};
    if (r1.ok) ib = await r1.json();
    if (r2.ok) stats = await r2.json();
    const active = ib.filter(x => x.active).length;
    const target = ib.reduce((a,x)=>a+(x.daily_target||0),0);
    $('#kpi-inboxes').textContent = ib.length;
    $('#kpi-active').textContent = active;
    $('#kpi-target').textContent = target;
  }catch(e){ /* ignore */ }
}
$('#btn-refresh-all').onclick = refreshAll;

/* ======================= INBOXES ======================= */
async function loadInboxes(){
  const body = $('#ibox-body');
  body.innerHTML = '<tr><td colspan="5" class="muted">Loading…</td></tr>';
  try{
    const r = await api('/inboxes');
    if(!r.ok) throw new Error('HTTP '+r.status);
    const data = await r.json();
    if (data.length === 0){
      body.innerHTML = '<tr><td colspan="5" class="muted">No inboxes yet.</td></tr>';
      return;
    }
    body.innerHTML = '';
    for(const ib of data){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${ib.label}</td>
        <td><input class="input" style="max-width:90px" type="number" min="1" value="${ib.daily_target||10}" data-field="daily_target"></td>
        <td><label class="checkbox"><input type="checkbox" ${ib.active?'checked':''} data-field="active"><span class="badge">${ib.active?'active':'paused'}</span></label></td>
        <td>${new Date(ib.created_at||Date.now()).toLocaleString()}</td>
        <td class="right">
          <button class="btn" data-act="save">Save</button>
          <button class="btn" data-act="peers">Peers</button>
        </td>`;
      body.appendChild(tr);

      // wire actions
      tr.querySelector('[data-act="save"]').onclick = async ()=>{
        const target = tr.querySelector('[data-field="daily_target"]').valueAsNumber || 10;
        const active = tr.querySelector('[data-field="active"]').checked;
        const r = await api(`/inboxes/${ib.id}`, {method:'PATCH', body: JSON.stringify({daily_target: target, active})});
        if(r.ok){ toast('Inbox saved','ok'); refreshKPIs(); } else { toast('Save failed (HTTP '+r.status+')','err'); }
      };
      tr.querySelector('[data-act="peers"]').onclick = ()=> openPeers(ib);
    }
  }catch(err){
    body.innerHTML = `<tr><td colspan="5" class="muted">Failed to load inboxes (${err.message})</td></tr>`;
  }
}
$('#btn-reload').onclick = loadInboxes;

// Create inbox
$('#btn-create').onclick = async ()=>{
  $('#create-err').textContent = '';
  const payload = {
    label: $('#f-label').value.trim(),
    daily_target: $('#f-target').valueAsNumber || 10,
    smtp_host: $('#f-smtp-host').value.trim(),
    smtp_port: +($('#f-smtp-port').value.trim() || 587),
    smtp_user: $('#f-smtp-user').value.trim(),
    smtp_pass: $('#f-smtp-pass').value,
    use_tls: $('#f-smtp-tls').checked,
    imap_host: $('#f-imap-host').value.trim(),
    imap_port: +($('#f-imap-port').value.trim() || 993),
    imap_user: $('#f-imap-user').value.trim(),
    imap_pass: $('#f-imap-pass').value,
    use_ssl: $('#f-imap-ssl').checked,
  };

  if (!payload.label || !payload.smtp_host || !payload.imap_host){
    $('#create-err').textContent = 'Label, SMTP host and IMAP host are required.'; return;
  }
  try{
    const r = await api('/inboxes', {method:'POST', body:JSON.stringify(payload)});
    if(!r.ok){ throw new Error('HTTP '+r.status); }
    toast('Inbox connected','ok');
    // clear sensitive fields
    $('#f-smtp-pass').value = ''; $('#f-imap-pass').value='';
    await loadInboxes(); await refreshKPIs();
  }catch(e){
    $('#create-err').textContent = 'Create failed: '+e.message;
    toast('Create failed','err');
  }
};

/* ======================= LOGS ======================= */
async function loadLogs(){
  const area = $('#logs-area');
  area.textContent = 'Loading…';
  try{
    const r = await api('/send-logs?limit=50');
    if(!r.ok) throw new Error('HTTP '+r.status);
    const logs = await r.json();
    area.textContent = (logs && logs.length)
      ? logs.map(l => typeof l==='string' ? l : JSON.stringify(l)).join('\n')
      : '(no logs yet)';
  }catch(e){ area.textContent = 'Failed to load logs: '+e.message; }
}
$('#btn-logs-reload').onclick = loadLogs;

/* ======================= RUN NOW ======================= */
async function runNow(){
  try{
    const r = await api('/run-now', {method:'POST'});
    if(r.ok) toast('Run dispatched','ok'); else toast('Run failed (HTTP '+r.status+')','err');
  }catch(e){ toast('Run failed: '+e.message,'err'); }
}
$('#btn-run-now').onclick = runNow;
$('#btn-run-now-2').onclick = runNow;

/* ======================= PEERS MODAL ======================= */
let currentPeerInboxId = null;
let currentPeerInboxLabel = null;

async function openPeers(inbox) {
  currentPeerInboxId = inbox.id;
  currentPeerInboxLabel = inbox.label || inbox.id;
  $('#peerTitle').textContent = `Peers for ${currentPeerInboxLabel}`;
  $('#peerInput').value = '';
  renderPeerList(null); // loading
  showPeerModal();
  await reloadPeers();
}
function showPeerModal() {
  const m = $('#peerModal');
  m.classList.add('show');
  m.setAttribute('aria-hidden', 'false');
}
function closePeerModal() {
  const m = $('#peerModal');
  m.classList.remove('show');
  m.setAttribute('aria-hidden', 'true');
}
$('#peerClose').onclick = closePeerModal;
$('#peerCloseBottom').onclick = closePeerModal;
$('#peerModal').addEventListener('click', (e)=>{
  if (e.target.id === 'peerModal') closePeerModal(); // backdrop close
});
document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closePeerModal(); });

async function reloadPeers() {
  try {
    const r = await api(`/peers?inbox_id=${encodeURIComponent(currentPeerInboxId)}`);
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    const peers = await r.json();
    renderPeerList(peers);
  } catch (err) {
    renderPeerList([]);
    toast(`Could not load peers (${err.message})`, 'err');
  }
}
function renderPeerList(peers) {
  const list = $('#peerList');
  if (peers === null) { list.innerHTML = '<div class="muted">Loading peers…</div>'; return; }
  if (!peers || peers.length === 0) { list.innerHTML = '<div class="muted">(no peers yet)</div>'; return; }
  list.innerHTML = '';
  for (const p of peers) {
    const el = document.createElement('div');
    el.className = 'pill';
    el.textContent = p.peer_email || p.email || String(p);
    list.appendChild(el);
  }
}
$('#peerAddBtn').onclick = async ()=>{
  const val = $('#peerInput').value.trim();
  if(!val){ toast('Enter a peer email','info'); return; }
  try{
    const r = await api('/peers', {method:'POST', body: JSON.stringify({ inbox_id: currentPeerInboxId, peer_email: val })});
    if(!r.ok) throw new Error('HTTP '+r.status);
    $('#peerInput').value='';
    toast('Peer added','ok');
    reloadPeers();
  }catch(e){ toast('Add failed: '+e.message,'err'); }
};

/* ======================= INIT ======================= */
async function refreshAll(){
  await Promise.all([loadInboxes(), loadLogs(), refreshKPIs()]);
}
$('#btn-reload').onclick = loadInboxes;
window.addEventListener('load', async ()=>{
  await ensureToken();
  if(ADMIN_TOKEN) refreshAll();
});
</script>
</body>
</html>
